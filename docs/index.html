if (!snapshot.exists()) {
  // Fetch templates from Firebase
  const templatesSnap = await get(dbRef(db, `global_templates`));
  if (!templatesSnap.exists()) {
    setMainContent(`
      <div class="text-red-600 text-center p-8">No templates are available. Please contact the administrator.</div>
    `);
    return;
  }
  const templates = templatesSnap.val();
  const templateOptions = Object.entries(templates).map(
    ([tid, tpl]) =>
      `<option value="${tid}" data-scope="${tpl.scope || tpl.type || ''}">${tpl.label || tid} (${tpl.scope || tpl.type || ''})</option>`
  ).join('');

  setMainContent(`
    <div class="flex flex-col items-center justify-center min-h-[60vh]">
      <h2 class="text-xl font-bold mb-2 text-gray-900">Assign Template to New Tether</h2>
      <p class="mb-4 text-gray-600">No tether found with ID: <span class="font-mono">${id}</span></p>
      <form id="assign-template-form" class="bg-gray-50 rounded-lg p-6 shadow max-w-md w-full">
        <label class="block mb-2 font-semibold">Select a Template</label>
        <select name="template" class="w-full mb-4 px-3 py-2 border rounded" required>
          <option value="">-- Select Template --</option>
          ${templateOptions}
        </select>
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-semibold">Assign Template</button>
      </form>
    </div>
  `);
  clearStatus();

  document.getElementById('assign-template-form').onsubmit = async (e) => {
    e.preventDefault();
    const form = e.target;
    const templateId = form.template.value;
    const selectedOption = form.template.selectedOptions[0];
    const scope = selectedOption.getAttribute('data-scope') || 'terra';
    // Create new tether in database
    const newTether = {
      type: scope,
      template: templateId,
      assigned: false
    };
    await update(dbRef(db, `tethers/${id}`), newTether);
    showStatus('Template assigned and tether created!', 'success');
    showTether(id); // proceed to normal flow
  };
  return;
}
