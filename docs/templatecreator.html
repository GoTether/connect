<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Template (Tether)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    body { background: #f6f7fa; font-family: sans-serif; }
    #main { max-width: 700px; margin: 2em auto; background: #fff; padding: 2em; border-radius: 12px; box-shadow: 0 2px 8px #ccc;}
    .section { background: #f2f6fa; border-radius: 8px; padding: 1em; margin-bottom: 1em; }
    .field-preview { background: #f6f7fa; border-radius: 8px; padding: 0.7em 1em; margin-bottom: 0.4em; }
    .field-controls { margin: 0.4em 0; }
    input, select, textarea { margin-bottom: 0.8em; padding: 0.4em; border-radius: 4px; border: 1px solid #ccc; width: 100%; box-sizing: border-box;}
    button { background: #0366d6; color: #fff; border: none; border-radius: 4px; padding: 0.4em 1em; cursor: pointer; margin-right: 0.5em;}
    button.remove { background: #c00; }
    button.premium { background: #ff9800; color: #fff; }
    .small { font-size: 0.92em; color: #666;}
    .live-preview { background: #f1f8e9; border-radius: 6px; padding: 1em; margin-top: 2em;}
  </style>
</head>
<body>
<div id="main">
  <h2>Create a New Template</h2>
  <form id="template-meta-form">
    <label><strong>Template Key (unique):</strong></label>
    <input type="text" id="template-key" required placeholder="e.g. car_maintenance">
    <label><strong>Template Label:</strong></label>
    <input type="text" id="template-label" required placeholder="e.g. Car Maintenance Log">
    <button type="submit" style="margin-bottom:2em;">Start Building Template</button>
  </form>
  <div id="builder" style="display:none;">
    <h3>Sections</h3>
    <div id="sections-list"></div>
    <form id="new-section-form" autocomplete="off">
      <input type="text" id="new-section-name" required placeholder="Section Name (e.g. Car Info)">
      <input type="text" id="new-section-desc" placeholder="Section Description (optional)">
      <button type="submit">Add Section</button>
    </form>
    <div id="section-builder" style="margin-top:2em;"></div>
    <div class="live-preview">
      <h3>Live Template Preview</h3>
      <div id="template-preview"></div>
      <button id="save-template-btn" style="margin-top:1em;">Save Template to Firebase</button>
      <div id="save-status" style="margin-top:1em; color:green; font-weight:bold;"></div>
    </div>
  </div>
</div>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAZoL7FPJ8wBqz_sX81Fo5eKXpsOVrLUZ0",
  authDomain: "tether-71e0c.firebaseapp.com",
  databaseURL: "https://tether-71e0c-default-rtdb.firebaseio.com",
  projectId: "tether-71e0c",
  storageBucket: "tether-71e0c.appspot.com",
  messagingSenderId: "277809008742",
  appId: "1:277809008742:web:2586a2b821d8da8f969da7",
  measurementId: "G-X7ZQ6DJYEN"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

let templateKey = "";
let templateLabel = "";
let sections = [];

document.getElementById("template-meta-form").onsubmit = function(e) {
  e.preventDefault();
  templateKey = document.getElementById("template-key").value.trim();
  templateLabel = document.getElementById("template-label").value.trim();
  if (!templateKey || !templateLabel) return;
  document.getElementById("builder").style.display = "";
  document.getElementById("template-meta-form").style.display = "none";
  renderSections();
  renderPreview();
};

function renderSections() {
  const list = document.getElementById("sections-list");
  list.innerHTML = "";
  sections.forEach((section, idx) => {
    const div = document.createElement("div");
    div.className = "section";
    div.innerHTML = `
      <strong>${section.name}</strong> 
      <span class="small">${section.description || ""}</span>
      <button class="remove" data-idx="${idx}">Remove</button>
      <button data-idx="${idx}" class="edit">Edit Fields</button>
      <div>
        ${section.fields.length ? `<div><em>Fields:</em> ${section.fields.map(f=>f.name).join(", ")}</div>` : "<div><em>No fields yet.</em></div>"}
      </div>
    `;
    list.appendChild(div);
  });
  // Remove section handler
  Array.from(document.querySelectorAll("button.remove")).forEach(btn => {
    btn.onclick = function() {
      sections.splice(+btn.dataset.idx, 1);
      renderSections();
      renderPreview();
      document.getElementById("section-builder").innerHTML = "";
    };
  });
  // Edit fields handler
  Array.from(document.querySelectorAll("button.edit")).forEach(btn => {
    btn.onclick = function() {
      buildSectionFields(+btn.dataset.idx);
    };
  });
}

document.getElementById("new-section-form").onsubmit = function(e) {
  e.preventDefault();
  const name = document.getElementById("new-section-name").value.trim();
  const desc = document.getElementById("new-section-desc").value.trim();
  if (!name) return;
  sections.push({name, description: desc, fields: []});
  renderSections();
  renderPreview();
  document.getElementById("new-section-name").value = "";
  document.getElementById("new-section-desc").value = "";
};

function buildSectionFields(sectionIdx) {
  const section = sections[sectionIdx];
  const builderDiv = document.getElementById("section-builder");
  builderDiv.innerHTML = `<h3>Editing Fields in "${section.name}"</h3>
    <div id="fields-list"></div>
    <form id="field-form">
      <div class="field-controls">
        <label>Field Name:</label>
        <input type="text" id="field-name" required placeholder="e.g. VIN">
        <label>Type:</label>
        <select id="field-type">
          <option value="text">Text</option>
          <option value="textarea">Text Area</option>
          <option value="number">Number</option>
          <option value="dropdown">Dropdown</option>
          <option value="radio">Radio Buttons</option>
          <option value="checkbox">Checkbox</option>
          <option value="image">Image Upload (Premium)</option>
        </select>
        <label>Static Field?</label> <input type="checkbox" id="field-static">
        <label>Required?</label> <input type="checkbox" id="field-required">
        <label>Help Text:</label>
        <input type="text" id="field-help" placeholder="Optional help text">
        <div id="field-options-div" style="display:none;">
          <label>Options (comma separated):</label>
          <input type="text" id="field-options" placeholder="e.g. Oil Change,Tire Rotation">
        </div>
        <label>Premium Field?</label> <input type="checkbox" id="field-premium" disabled>
        <button type="submit">Add Field</button>
      </div>
    </form>
  `;
  renderFieldsList(sectionIdx);

  document.getElementById("field-type").onchange = function() {
    const type = this.value;
    document.getElementById("field-options-div").style.display = (type === "dropdown" || type === "radio") ? "" : "none";
    document.getElementById("field-premium").disabled = type !== "image";
    if (type !== "image") document.getElementById("field-premium").checked = false;
  };

  document.getElementById("field-form").onsubmit = function(e) {
    e.preventDefault();
    const name = document.getElementById("field-name").value.trim();
    const type = document.getElementById("field-type").value;
    const staticField = document.getElementById("field-static").checked;
    const required = document.getElementById("field-required").checked;
    const help = document.getElementById("field-help").value.trim();
    const premium = document.getElementById("field-premium").checked && type === "image";
    let options = [];
    if (type === "dropdown" || type === "radio") {
      options = document.getElementById("field-options").value.split(",").map(opt=>opt.trim()).filter(opt=>opt);
    }
    if (!name) return;
    section.fields.push({name, type, static: staticField, required, help, options, premium});
    renderFieldsList(sectionIdx);
    renderPreview();
    this.reset();
    document.getElementById("field-options-div").style.display="none";
    document.getElementById("field-premium").disabled=true;
  };
}

function renderFieldsList(sectionIdx) {
  const fieldsListDiv = document.getElementById("fields-list");
  const fields = sections[sectionIdx].fields;
  fieldsListDiv.innerHTML = "";
  fields.forEach((field, idx) => {
    const div = document.createElement("div");
    div.className = "field-preview";
    div.innerHTML = `
      <b>${field.name}</b> (${field.type}) 
      ${field.static ? "<span class='small'>[static]</span>" : ""}
      ${field.required ? "<span class='small'>[required]</span>" : ""}
      ${field.premium ? "<span class='small premium'>[premium]</span>" : ""}
      ${field.help ? `<span class='small'> - ${field.help}</span>` : ""}
      ${field.options && field.options.length ? `<br><span class='small'>Options: ${field.options.join(", ")}</span>` : ""}
      <button class="remove" data-idx="${idx}">Remove</button>
    `;
    fieldsListDiv.appendChild(div);
  });
  Array.from(fieldsListDiv.querySelectorAll("button.remove")).forEach(btn => {
    btn.onclick = function() {
      fields.splice(+btn.dataset.idx, 1);
      renderFieldsList(sectionIdx);
      renderPreview();
    };
  });
}

function renderPreview() {
  const previewDiv = document.getElementById("template-preview");
  previewDiv.innerHTML = `
    <b>Key:</b> ${templateKey} <br>
    <b>Label:</b> ${templateLabel} <br>
    <b>Sections:</b>
    <ol>
      ${sections.map(s=>`<li>
        <b>${s.name}</b> ${s.description ? `- <span class="small">${s.description}</span>` : ""}
        <ul>
        ${s.fields.map(f=>`<li>
          <b>${f.name}</b> <span class="small">(${f.type}${f.static?"/static":""}${f.required?"/required":""}${f.premium?"/premium":""})</span>
          ${f.help ? `<span class="small"> - ${f.help}</span>` : ""}
          ${f.options && f.options.length ? `<span class="small"> Options: ${f.options.join(", ")}</span>` : ""}
        </li>`).join("")}
        </ul>
      </li>`).join("")}
    </ol>
  `;
}

document.getElementById("save-template-btn").onclick = async function() {
  if (!templateKey || !templateLabel || !sections.length) {
    alert("You must provide key, label, and at least one section.");
    return;
  }
  // Check uniqueness
  const templateRef = database.ref('global_templates/' + templateKey);
  const existing = await templateRef.get();
  if (existing.exists()) {
    alert("A template with this key already exists. Please use a unique key.");
    return;
  }
  // Structure
  const templateData = {
    label: templateLabel,
    sections: sections,
    version: 1
  };
  try {
    await templateRef.set(templateData);
    document.getElementById("save-status").textContent = "Template saved!";
    // Optionally reset form for new template
  } catch (err) {
    document.getElementById("save-status").textContent = "";
    alert("Error saving template: " + err.message);
  }
};
</script>
</body>
</html>
