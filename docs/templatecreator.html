<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Template (Tether)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    body { background: #f7f8fa; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; }
    #main { max-width: 800px; margin: 2em auto; background: #fff; padding: 2em 2em 3em 2em; border-radius: 16px; box-shadow: 0 4px 16px #e0e4eb; }
    .step-title { font-size: 1.5em; font-weight: bold; margin-bottom: 0.5em; }
    .help-text { color: #666; margin-bottom: 1em; font-size: 1em; }
    .input-block { padding: 1.5em; background: #f2f6fa; border-radius: 12px; margin-bottom: 2em; box-shadow: 0 2px 7px #e4e8ef; }
    input, select, textarea { font-size: 1.1em; padding: 0.7em; border-radius: 6px; border: 1px solid #ccc; width: 100%; margin-bottom: 1em; box-sizing: border-box; }
    button { background: #2b90ff; color: #fff; border: none; border-radius: 6px; padding: 0.7em 1.5em; font-size: 1.1em; cursor: pointer; margin-right: 0.7em; margin-top: 0.3em; box-shadow: 0 2px 6px #d8e6f9; transition: background 0.2s; }
    button:disabled { background: #bbb; cursor: not-allowed; }
    button:hover:not(:disabled) { background: #176fd2; }
    .card { background: #f0f4fa; border-radius: 16px; margin-bottom: 2em; padding: 1.5em 1.2em; box-shadow: 0 2px 12px #e0e4eb; position: relative; }
    .section-title { font-weight: bold; font-size: 1.18em; margin-bottom: 0.3em; color: #2b90ff; letter-spacing: 0.02em;}
    .section-desc { color: #666; margin-bottom: 1em; font-size: 1em; }
    .section-actions { position: absolute; top: 1em; right: 1em; display: flex; gap: 0.2em; }
    .field-list { margin-top: 0.8em; margin-bottom: 0.8em; display: flex; flex-direction: column; gap: 1em;}
    .field-pill { background: #fff; border-radius: 14px; padding: 1em 1.2em; margin-bottom: 0.4em; box-shadow: 0 1px 6px #e0e4eb; border-left: 6px solid #2b90ff; min-width: 180px; position: relative; display: flex; flex-direction: column; gap: 0.4em;}
    .field-label { font-weight: bold; font-size: 1.08em; color: #222; margin-bottom: 0.2em;}
    .field-type-badge { background: #e4e8ef; color: #2b90ff; border-radius: 8px; padding: 0.2em 0.7em; font-size: 0.93em; margin-left: 0.4em; display: inline-block;}
    .static-badge { background: #27ae60; color: #fff; border-radius: 6px; padding: 0.2em 0.7em; font-size: 0.95em; margin-left: 0.5em;}
    .dynamic-badge { background: #2b90ff; color: #fff; border-radius: 6px; padding: 0.2em 0.7em; font-size: 0.95em; margin-left: 0.5em;}
    .required-badge { background: #27ae60; color: #fff; border-radius: 6px; padding: 0.15em 0.7em; font-size: 0.92em; margin-left: 0.5em;}
    .options-badge { background: #f39c12; color: #fff; border-radius: 6px; padding: 0.15em 0.7em; font-size: 0.92em; margin-left: 0.5em;}
    .description { color: #666; font-size: 0.98em; margin-bottom: 0.3em;}
    .remove-btn, .edit-btn { background: #e74c3c; color: #fff; border: none; border-radius: 6px; padding: 0.4em 1em; font-size: 0.95em; cursor: pointer; margin-left: 0.7em; margin-top: 0.3em; }
    .remove-btn:hover, .edit-btn:hover { background: #c0392b; }
    .indented-add-field-btn { background: #2b90ff; color: #fff; margin: 0.7em 0 0 2em; display: block; width: fit-content; }
    .indented-add-field-btn:hover { background: #176fd2; }
    .edit-field-btn { background: #f39c12; color: #fff; border: none; border-radius: 6px; padding: 0.4em 1em; font-size: 0.95em; cursor: pointer; margin-left: 0.6em; margin-top: 0.3em; }
    .edit-field-btn:hover { background: #c87c09; }
    .preview-block { background: #effbe0; border-radius: 16px; padding: 2em; margin-top: 2em; box-shadow: 0 2px 12px #cde6b6; }
    .error-message { color: #e74c3c; margin-bottom: 1em; font-weight: bold; }
    .success-message { color: #27ae60; margin-top: 1em; font-weight: bold; font-size: 1.1em; }
    .inline-field-form { background: #fff; border-radius: 8px; padding: 1em; margin-bottom: 0.7em; box-shadow: 0 1px 5px #e0e4eb; border-left: 4px solid #2b90ff; }
    .edit-section-form { background: #fff; border-radius: 8px; padding: 1em; margin-bottom: 0.7em; box-shadow: 0 1px 5px #e0e4eb; border-left: 4px solid #f39c12; }
    .toggle-btn { border: none; border-radius: 6px; padding: 0.5em 1.2em; font-size: 1em; cursor: pointer; margin-right: 1em; transition: background 0.2s, color 0.2s; }
    .toggle-yes { background: #27ae60; color: #fff; }
    .toggle-no { background: #e74c3c; color: #fff; }
    .after-save-btns { margin-top: 2em; display: flex; gap: 1em; }
    .modal-bg { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:9999; display:flex; justify-content:center; align-items:center;}
    .modal { background:#fff; border-radius:12px; padding:2em 2em; box-shadow:0 2px 12px #bbb; font-size:1.1em; }
    .modal button { margin:1em 0.5em 0 0; }
    .template-label-display { display:flex; align-items:center; gap:1em; margin-bottom:1em; }
    #edit-template-label-btn { font-size:1em; padding:0.4em 1em; background:#f39c12; color:#fff; border:none; border-radius:6px; margin-left:0.5em; cursor:pointer;}
    #edit-template-label-btn:hover { background:#c87c09; }
    #edit-template-label-form { display:flex; align-items:center; gap:0.5em; margin-bottom:1em;}
    #edit-template-label-input { font-size:1.2em; padding:0.3em 0.6em;}
    #save-template-label-btn { font-size:1em; padding:0.4em 1em; background:#27ae60; color:#fff; border:none; border-radius:6px; margin-left:0.5em; cursor:pointer;}
    #save-template-label-btn:hover { background:#1a7342; }
    #cancel-template-label-btn { font-size:1em; padding:0.4em 1em; background:#e74c3c; color:#fff; border:none; border-radius:6px; margin-left:0.5em; cursor:pointer;}
    #cancel-template-label-btn:hover { background:#c0392b; }
    @media (max-width: 700px) { #main { padding: 1em; } .input-block, .card, .preview-block { padding: 1em; } .section-actions { position: static; margin-top:0.7em; } .indented-add-field-btn { margin-left: 0; } .after-save-btns { flex-direction: column; gap: 0.5em; } }
  </style>
</head>
<body>
<div id="main">
  <!-- STEP 1: NAME -->
  <div id="step-name" class="input-block">
    <div class="step-title">Create a New Template</div>
    <div class="help-text">Start by naming your template.<br><span style="color:#999;">(Example: Car Maintenance Log)</span></div>
    <input type="text" id="template-name" required placeholder="Template Name">
    <button id="start-btn">Next</button>
    <div id="name-error" class="error-message"></div>
  </div>
  <!-- STEP 2: SECTIONS + FIELDS -->
  <div id="builder-area" style="display:none;">
    <div class="template-label-display" id="template-label-display" style="display:none;">
      <span id="template-label-text" style="font-size:1.4em; font-weight:700; color:#2b90ff;"></span>
      <button id="edit-template-label-btn" title="Edit template name">Edit Name</button>
    </div>
    <form id="edit-template-label-form" style="display:none;">
      <input type="text" id="edit-template-label-input" required>
      <button id="save-template-label-btn" type="submit">Save</button>
      <button id="cancel-template-label-btn" type="button">Cancel</button>
      <span id="edit-template-label-error" class="error-message"></span>
    </form>
    <div class="step-title" style="margin-bottom:1.2em;">Build your template</div>
    <div class="help-text">First section is for static details (e.g., Car Details). You must add at least one static field before continuing.</div>
    <div id="sections-list"></div>
    <div id="add-section-wrap"></div>
    <button id="preview-btn" style="float:right;">Preview</button>
    <div style="clear:both;"></div>
    <div id="section-error" class="error-message"></div>
  </div>
  <!-- PREVIEW & SAVE -->
  <div id="step-preview" class="preview-block" style="display:none;">
    <div class="step-title">Preview your Template</div>
    <div id="preview-content"></div>
    <div id="after-save-btns" class="after-save-btns" style="display:none;">
      <button id="create-another-btn">Create Another Template</button>
      <button id="admin-btn">Go to Admin Page</button>
    </div>
    <button id="save-template-btn" style="margin-top:2em;">Save</button>
    <div id="save-status" class="success-message"></div>
    <button id="edit-btn" style="margin-top:2em;">Go Back & Edit</button>
  </div>
</div>
<!-- Modal for overwrite warning -->
<div id="modal-bg" class="modal-bg" style="display:none;">
  <div class="modal" id="modal-content">
    <div id="modal-message"></div>
    <button id="modal-confirm-btn">Yes, Overwrite</button>
    <button id="modal-cancel-btn">Cancel</button>
  </div>
</div>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAZoL7FPJ8wBqz_sX81Fo5eKXpsOVrLUZ0",
  authDomain: "tether-71e0c.firebaseapp.com",
  databaseURL: "https://tether-71e0c-default-rtdb.firebaseio.com",
  projectId: "tether-71e0c",
  storageBucket: "tether-71e0c.appspot.com",
  messagingSenderId: "277809008742",
  appId: "1:277809008742:web:2586a2b821d8da8f969da7",
  measurementId: "G-X7ZQ6DJYEN"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

let templateKey = "";
let templateLabel = "";
let sections = [];
let addingFieldToSectionIdx = null;
let editingSectionIdx = null;
let editMode = false; // True if user goes back to edit after saving

function generateKey(name) {
  return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '').replace(/--+/g, '-');
}

// Add Enter-to-save for template name input
const templateNameInput = document.getElementById("template-name");
templateNameInput.addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    document.getElementById("start-btn").click();
  }
});

// STEP 1: Name
document.getElementById("start-btn").onclick = async function() {
  const nameInput = document.getElementById("template-name").value.trim();
  if (!nameInput) return;
  document.getElementById("name-error").textContent = "";
  const key = generateKey(nameInput);

  // Check uniqueness in Firebase
  const templateRef = database.ref('global_templates/' + key);
  const existing = await templateRef.get();
  if (existing.exists()) {
    document.getElementById("name-error").textContent = "A template with this name already exists. Please try a different name.";
    return;
  }
  templateKey = key;
  templateLabel = nameInput;
  // Preload static section, cannot be deleted
  sections = [{
    name: "Static Details",
    description: "Enter static info about your item (e.g., Car, Device, etc.). You must add at least one field.",
    fields: [],
    type: "static",
    undeletable: true
  }];
  document.getElementById("step-name").style.display = "none";
  document.getElementById("builder-area").style.display = "";
  updateTemplateLabelDisplay();
  renderSections();
};

// --- Editable template label ---
function updateTemplateLabelDisplay() {
  const labelDisplay = document.getElementById("template-label-display");
  const labelText = document.getElementById("template-label-text");
  labelText.textContent = templateLabel;
  labelDisplay.style.display = templateLabel ? "flex" : "none";
  document.getElementById("edit-template-label-form").style.display = "none";
}

// Edit button click
document.getElementById("edit-template-label-btn").onclick = function() {
  document.getElementById("template-label-display").style.display = "none";
  document.getElementById("edit-template-label-form").style.display = "flex";
  const input = document.getElementById("edit-template-label-input");
  input.value = templateLabel;
  input.focus();
  document.getElementById("edit-template-label-error").textContent = "";
};

// Save label form
document.getElementById("edit-template-label-form").onsubmit = async function(e) {
  e.preventDefault();
  const input = document.getElementById("edit-template-label-input");
  const newLabel = input.value.trim();
  if (!newLabel) {
    document.getElementById("edit-template-label-error").textContent = "Template name required.";
    return;
  }

  // Check uniqueness in Firebase if label changes to a new key
  const newKey = generateKey(newLabel);
  if (newKey !== templateKey) {
    const templateRef = database.ref('global_templates/' + newKey);
    const existing = await templateRef.get();
    if (existing.exists()) {
      document.getElementById("edit-template-label-error").textContent = "A template with this name already exists.";
      return;
    }
    templateKey = newKey;
  }
  templateLabel = newLabel;
  updateTemplateLabelDisplay();
};

// Cancel label edit
document.getElementById("cancel-template-label-btn").onclick = function() {
  updateTemplateLabelDisplay();
};

// Section Form (inline, below the appropriate section)
function showSectionForm(insertIdx = null) {
  const list = document.getElementById("sections-list");
  Array.from(list.querySelectorAll(".input-block")).forEach(formDiv => {
    if (formDiv.querySelector("#new-section-form")) formDiv.remove();
  });
  const formDiv = document.createElement("div");
  formDiv.className = "input-block";
  formDiv.style.marginBottom = "1.5em";
  let sectionType = sections.length === 0 ? 'static' : 'dynamic';
  let sectionTypeLabel = sectionType === 'static'
    ? '<span class="static-badge">Static Section</span>'
    : '<span class="dynamic-badge">Dynamic Section</span>';
  let descHint = sectionType === 'static'
    ? 'Section for static details (e.g., Car Details).'
    : 'Section for dynamic data (e.g., Log Entry, Maintenance Record).';

  formDiv.innerHTML = `
    <form id="new-section-form">
      <div style="margin-bottom:0.6em;">${sectionTypeLabel} ${descHint}</div>
      <input type="text" id="new-section-name" required placeholder="Section Name">
      <input type="text" id="new-section-desc" placeholder="Description (optional)">
      <button id="new-section-save-btn">Save Section</button>
      <button id="new-section-cancel-btn" type="button" style="background:#777;">Cancel</button>
      <div id="section-form-error" class="error-message"></div>
    </form>
  `;

  formDiv.querySelector("#new-section-name").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      formDiv.querySelector("#new-section-save-btn").click();
    }
  });

  if (insertIdx === null || insertIdx >= sections.length) {
    list.appendChild(formDiv);
  } else {
    let cards = Array.from(list.querySelectorAll('.card'));
    if (cards[insertIdx]) {
      cards[insertIdx].after(formDiv);
    } else {
      list.appendChild(formDiv);
    }
  }

  document.getElementById("new-section-form").onsubmit = function(e) {
    e.preventDefault();
    const name = document.getElementById("new-section-name").value.trim();
    const desc = document.getElementById("new-section-desc").value.trim();
    if (!name) {
      document.getElementById("section-form-error").textContent = "Section name required.";
      return;
    }
    sections.push({
      name,
      description: desc,
      fields: [],
      type: sectionType,
      undeletable: false
    });
    renderSections();
  };
  document.getElementById("new-section-cancel-btn").onclick = function() {
    formDiv.remove();
  };
}

// Edit Section Form (inline)
function showEditSectionForm(sectionIdx) {
  if (editingSectionIdx !== null) {
    document.getElementById(`edit-section-form-wrap-${editingSectionIdx}`).innerHTML = '';
  }
  editingSectionIdx = sectionIdx;
  const wrap = document.getElementById(`edit-section-form-wrap-${sectionIdx}`);
  let sectionType = sections[sectionIdx].type || (sectionIdx === 0 ? 'static' : 'dynamic');
  let sectionTypeLabel = sectionType === 'static'
    ? '<span class="static-badge">Static Section</span>'
    : '<span class="dynamic-badge">Dynamic Section</span>';
  wrap.innerHTML = `
    <form id="edit-section-form-${sectionIdx}" class="edit-section-form">
      <div style="margin-bottom:0.6em;">${sectionTypeLabel}</div>
      <input type="text" id="edit-section-name-${sectionIdx}" required value="${sections[sectionIdx].name}" placeholder="Section Name">
      <input type="text" id="edit-section-desc-${sectionIdx}" value="${sections[sectionIdx].description || ''}" placeholder="Description (optional)">
      <button type="submit">Save Changes</button>
      <button type="button" id="edit-section-cancel-btn-${sectionIdx}" style="background:#777;">Cancel</button>
      <div id="edit-section-error-${sectionIdx}" class="error-message"></div>
    </form>
  `;

  wrap.querySelector(`#edit-section-name-${sectionIdx}`).addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      wrap.querySelector("button[type=submit]").click();
    }
  });

  document.getElementById(`edit-section-form-${sectionIdx}`).onsubmit = function(e) {
    e.preventDefault();
    const name = document.getElementById(`edit-section-name-${sectionIdx}`).value.trim();
    const desc = document.getElementById(`edit-section-desc-${sectionIdx}`).value.trim();
    if (!name) {
      document.getElementById(`edit-section-error-${sectionIdx}`).textContent = "Section name required.";
      return;
    }
    sections[sectionIdx].name = name;
    sections[sectionIdx].description = desc;
    wrap.innerHTML = '';
    editingSectionIdx = null;
    renderSections();
  };
  document.getElementById(`edit-section-cancel-btn-${sectionIdx}`).onclick = function() {
    wrap.innerHTML = '';
    editingSectionIdx = null;
  };
}

// Show Field Edit Form (inline under section)
function showEditFieldForm(sectionIdx, fieldIdx) {
  if (addingFieldToSectionIdx !== null) {
    document.getElementById(`field-form-wrap-${addingFieldToSectionIdx}`).innerHTML = '';
    addingFieldToSectionIdx = null;
  }
  const wrap = document.getElementById(`field-form-wrap-${sectionIdx}`);
  const field = sections[sectionIdx].fields[fieldIdx];
  let isStatic = field.static;
  let isRequired = field.required;
  wrap.innerHTML = `
    <form id="edit-field-form-${sectionIdx}-${fieldIdx}" class="inline-field-form" autocomplete="off">
      <input type="text" id="edit-field-name-${sectionIdx}-${fieldIdx}" required value="${field.name}" placeholder="Field Name">
      <select id="edit-field-type-${sectionIdx}-${fieldIdx}">
        <option value="text"${field.type === "text" ? " selected" : ""}>Text</option>
        <option value="textarea"${field.type === "textarea" ? " selected" : ""}>Text Area</option>
        <option value="number"${field.type === "number" ? " selected" : ""}>Number</option>
        <option value="dropdown"${field.type === "dropdown" ? " selected" : ""}>Dropdown</option>
        <option value="radio"${field.type === "radio" ? " selected" : ""}>Radio Buttons</option>
        <option value="checkbox"${field.type === "checkbox" ? " selected" : ""}>Checkbox</option>
        <option value="image"${field.type === "image" ? " selected" : ""}>Image Upload</option>
      </select>
      <input type="text" id="edit-field-help-${sectionIdx}-${fieldIdx}" value="${field.help || ""}" placeholder="Help text (optional)">
      <div id="edit-options-wrap-${sectionIdx}-${fieldIdx}" style="display:none;">
        <input type="text" id="edit-field-options-${sectionIdx}-${fieldIdx}" value="${field.options ? field.options.join(", ") : ""}" placeholder="Options (comma separated)">
      </div>
      <div style="margin-bottom:1em;">
        <button type="button" id="edit-static-toggle-${sectionIdx}-${fieldIdx}" class="toggle-btn">Static: ${isStatic ? "Yes" : "No"}</button>
        <button type="button" id="edit-required-toggle-${sectionIdx}-${fieldIdx}" class="toggle-btn">Required: ${isRequired ? "Yes" : "No"}</button>
      </div>
      <button type="submit">Save</button>
      <button type="button" id="edit-field-cancel-btn-${sectionIdx}-${fieldIdx}" style="background:#777;">Cancel</button>
      <div id="edit-field-error-${sectionIdx}-${fieldIdx}" class="error-message"></div>
    </form>
  `;

  const nameInput = document.getElementById(`edit-field-name-${sectionIdx}-${fieldIdx}`);
  nameInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById(`edit-field-form-${sectionIdx}-${fieldIdx}`).requestSubmit();
    }
  });

  const typeSelect = document.getElementById(`edit-field-type-${sectionIdx}-${fieldIdx}`);
  const optionsWrap = document.getElementById(`edit-options-wrap-${sectionIdx}-${fieldIdx}`);
  function toggleOptionsInput() {
    if (typeSelect.value === "dropdown") {
      optionsWrap.style.display = "";
    } else {
      optionsWrap.style.display = "none";
    }
  }
  typeSelect.onchange = toggleOptionsInput;
  toggleOptionsInput();

  const staticBtn = document.getElementById(`edit-static-toggle-${sectionIdx}-${fieldIdx}`);
  const requiredBtn = document.getElementById(`edit-required-toggle-${sectionIdx}-${fieldIdx}`);
  function updateToggleUI() {
    staticBtn.textContent = "Static: " + (isStatic ? "Yes" : "No");
    staticBtn.className = "toggle-btn " + (isStatic ? "toggle-yes" : "toggle-no");
    staticBtn.disabled = (sectionIdx === 0);
    requiredBtn.textContent = "Required: " + (isRequired ? "Yes" : "No");
    requiredBtn.className = "toggle-btn " + (isRequired ? "toggle-yes" : "toggle-no");
  }
  updateToggleUI();
  staticBtn.onclick = function() {
    if (sectionIdx === 0) return;
    isStatic = !isStatic;
    updateToggleUI();
  };
  requiredBtn.onclick = function() {
    isRequired = !isRequired;
    updateToggleUI();
  };

  document.getElementById(`edit-field-form-${sectionIdx}-${fieldIdx}`).onsubmit = function(e) {
    e.preventDefault();
    const name = document.getElementById(`edit-field-name-${sectionIdx}-${fieldIdx}`).value.trim();
    const type = document.getElementById(`edit-field-type-${sectionIdx}-${fieldIdx}`).value;
    const help = document.getElementById(`edit-field-help-${sectionIdx}-${fieldIdx}`).value.trim();
    const optionsRaw = document.getElementById(`edit-field-options-${sectionIdx}-${fieldIdx}`) ? document.getElementById(`edit-field-options-${sectionIdx}-${fieldIdx}`).value : "";
    let options = [];
    if (type === "dropdown") {
      options = optionsRaw.split(",").map(opt=>opt.trim()).filter(opt=>opt);
    }
    if (!name) {
      document.getElementById(`edit-field-error-${sectionIdx}-${fieldIdx}`).textContent = "Field name required.";
      return;
    }
    sections[sectionIdx].fields[fieldIdx] = {
      name,
      type,
      static: sectionIdx === 0 ? true : isStatic,
      required: isRequired,
      help,
      options
    };
    wrap.innerHTML = '';
    renderFieldsList(sectionIdx);
  };
  document.getElementById(`edit-field-cancel-btn-${sectionIdx}-${fieldIdx}`).onclick = function() {
    wrap.innerHTML = '';
  };
}

function renderSections() {
  const list = document.getElementById("sections-list");
  list.innerHTML = "";
  sections.forEach((section, idx) => {
    const div = document.createElement("div");
    div.className = "card";
    let sectionTypeLabel = section.type === 'static'
      ? '<span class="static-badge">Static Section</span>'
      : '<span class="dynamic-badge">Dynamic Section</span>';
    div.innerHTML = `
      <div class="section-title">${section.name} ${sectionTypeLabel}</div>
      <div class="section-desc">${section.description || ""}</div>
      <div class="section-actions">
        ${!section.undeletable ? `<button class="remove-btn" data-idx="${idx}">Delete</button>` : ""}
        <button class="edit-btn" data-idx="${idx}">Edit</button>
      </div>
      <div class="field-list" id="fields-list-${idx}"></div>
      <div id="field-form-wrap-${idx}"></div>
      <div id="edit-section-form-wrap-${idx}"></div>
      <button class="indented-add-field-btn" data-idx="${idx}">+ Add Field</button>
    `;
    list.appendChild(div);

    renderFieldsList(idx);

    if (!section.undeletable) {
      div.querySelector(".remove-btn").onclick = function() {
        sections.splice(idx, 1);
        renderSections();
      };
    }
    div.querySelector(".edit-btn").onclick = function() {
      showEditSectionForm(idx);
    };
    div.querySelector(".indented-add-field-btn").onclick = function() {
      showFieldForm(idx);
    };
  });

  const addSectionWrap = document.getElementById("add-section-wrap");
  addSectionWrap.innerHTML = '';
  const addSectionBtn = document.createElement("button");
  addSectionBtn.textContent = "+ Add Section";
  addSectionBtn.style.marginBottom = "2em";
  addSectionBtn.onclick = function() {
    showSectionForm(sections.length-1);
  };
  addSectionWrap.appendChild(addSectionBtn);
}

// Show Field Form (inline under section)
function showFieldForm(sectionIdx) {
  if (addingFieldToSectionIdx !== null) {
    document.getElementById(`field-form-wrap-${addingFieldToSectionIdx}`).innerHTML = '';
  }
  addingFieldToSectionIdx = sectionIdx;
  const wrap = document.getElementById(`field-form-wrap-${sectionIdx}`);
  let isStatic = sectionIdx === 0 ? true : false;
  let isRequired = false;

  wrap.innerHTML = `
    <form id="new-field-form-${sectionIdx}" class="inline-field-form" autocomplete="off">
      <input type="text" id="field-name-${sectionIdx}" required placeholder="Field Name">
      <select id="field-type-${sectionIdx}">
        <option value="text">Text</option>
        <option value="textarea">Text Area</option>
        <option value="number">Number</option>
        <option value="dropdown">Dropdown</option>
        <option value="radio">Radio Buttons</option>
        <option value="checkbox">Checkbox</option>
        <option value="image">Image Upload</option>
      </select>
      <input type="text" id="field-help-${sectionIdx}" placeholder="Help text (optional)">
      <div id="options-wrap-${sectionIdx}" style="display:none;">
        <input type="text" id="field-options-${sectionIdx}" placeholder="Options (comma separated)">
      </div>
      <div style="margin-bottom:1em;">
        <button type="button" id="static-toggle-${sectionIdx}" class="toggle-btn">Static: Yes</button>
        <button type="button" id="required-toggle-${sectionIdx}" class="toggle-btn">Required: No</button>
      </div>
      <button type="submit">Save</button>
      <button type="button" id="field-cancel-btn-${sectionIdx}" style="background:#777;">Cancel</button>
      <div id="field-error-${sectionIdx}" class="error-message"></div>
    </form>
  `;

  const nameInput = document.getElementById(`field-name-${sectionIdx}`);
  nameInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById(`new-field-form-${sectionIdx}`).requestSubmit();
    }
  });

  const typeSelect = document.getElementById(`field-type-${sectionIdx}`);
  const optionsWrap = document.getElementById(`options-wrap-${sectionIdx}`);
  function toggleOptionsInput() {
    if (typeSelect.value === "dropdown") {
      optionsWrap.style.display = "";
    } else {
      optionsWrap.style.display = "none";
    }
  }
  typeSelect.onchange = toggleOptionsInput;
  toggleOptionsInput();

  const staticBtn = document.getElementById(`static-toggle-${sectionIdx}`);
  const requiredBtn = document.getElementById(`required-toggle-${sectionIdx}`);

  function updateToggleUI() {
    staticBtn.textContent = "Static: " + (isStatic ? "Yes" : "No");
    staticBtn.className = "toggle-btn " + (isStatic ? "toggle-yes" : "toggle-no");
    staticBtn.disabled = (sectionIdx === 0);
    requiredBtn.textContent = "Required: " + (isRequired ? "Yes" : "No");
    requiredBtn.className = "toggle-btn " + (isRequired ? "toggle-yes" : "toggle-no");
  }
  updateToggleUI();
  staticBtn.onclick = function() {
    if (sectionIdx === 0) return;
    isStatic = !isStatic;
    updateToggleUI();
  };
  requiredBtn.onclick = function() {
    isRequired = !isRequired;
    updateToggleUI();
  };

  document.getElementById(`new-field-form-${sectionIdx}`).onsubmit = function(e) {
    e.preventDefault();
    const name = document.getElementById(`field-name-${sectionIdx}`).value.trim();
    const type = document.getElementById(`field-type-${sectionIdx}`).value;
    const help = document.getElementById(`field-help-${sectionIdx}`).value.trim();
    const optionsRaw = document.getElementById(`field-options-${sectionIdx}`) ? document.getElementById(`field-options-${sectionIdx}`).value : "";
    let options = [];
    if (type === "dropdown") {
      options = optionsRaw.split(",").map(opt=>opt.trim()).filter(opt=>opt);
    }
    if (!name) {
      document.getElementById(`field-error-${sectionIdx}`).textContent = "Field name required.";
      return;
    }
    sections[sectionIdx].fields.push({
      name,
      type,
      static: sectionIdx === 0 ? true : isStatic,
      required: isRequired,
      help,
      options
    });
    wrap.innerHTML = '';
    addingFieldToSectionIdx = null;
    renderFieldsList(sectionIdx);
  };
  document.getElementById(`field-cancel-btn-${sectionIdx}`).onclick = function() {
    wrap.innerHTML = '';
    addingFieldToSectionIdx = null;
  };
}

function renderFieldsList(sectionIdx) {
  const fieldsListDiv = document.getElementById(`fields-list-${sectionIdx}`);
  fieldsListDiv.innerHTML = "";
  const fields = sections[sectionIdx].fields;
  fields.forEach((field, idx) => {
    const div = document.createElement("div");
    div.className = "field-pill";
    div.innerHTML = `
      <div>
        <span class="field-label">${field.name}</span>
        <span class="field-type-badge">${field.type}</span>
        ${field.static ? "<span class='static-badge'>Static</span>" : ""}
        ${field.required ? "<span class='required-badge'>Required</span>" : ""}
        ${field.options && field.options.length ? "<span class='options-badge'>Options</span>" : ""}
      </div>
      ${field.help ? `<div class="description">${field.help}</div>` : ""}
      ${field.options && field.options.length ? `<div class="description" style="color:#f39c12;">${field.options.join(", ")}</div>` : ""}
      <button class="edit-field-btn" data-section="${sectionIdx}" data-field="${idx}">Edit</button>
      <button class="remove-btn" data-idx="${idx}" style="align-self:flex-end; margin-top:0.2em;">Delete Field</button>
    `;
    fieldsListDiv.appendChild(div);

    div.querySelector(".edit-field-btn").onclick = function() {
      showEditFieldForm(sectionIdx, idx);
    };
    div.querySelector(".remove-btn").onclick = function() {
      fields.splice(idx, 1);
      renderFieldsList(sectionIdx);
    };
  });
}

// --- Preview & Save ---
document.getElementById("preview-btn").onclick = function() {
  let valid = true, errorMsg = "";
  if (!templateLabel || !templateKey) {
    valid = false; errorMsg = "Missing template name.";
  } else if (!sections.length) {
    valid = false; errorMsg = "Add at least one section before previewing.";
  } else if (!sections[0].fields.length) {
    valid = false; errorMsg = "You must add at least one static field before previewing.";
  } else if (!sections.every(s => s.fields.length)) {
    valid = false; errorMsg = "Each section needs at least one field.";
  }
  document.getElementById("section-error").textContent = valid ? "" : errorMsg;
  if (!valid) return;
  document.getElementById("builder-area").style.display = "none";
  document.getElementById("step-preview").style.display = "";
  renderPreview();
  document.getElementById("after-save-btns").style.display = "none";
  document.getElementById("save-template-btn").style.display = "";
  document.getElementById("save-status").textContent = "";
  editMode = false;
};

function renderPreview() {
  const previewDiv = document.getElementById("preview-content");
  previewDiv.innerHTML = `
    <div style="font-size:1.25em; font-weight:700; margin-bottom:0.4em; color:#2b90ff; letter-spacing:0.02em;">${templateLabel}</div>
    <div style="color:#666; margin-bottom:1em;">Key: <span style="color:#2b90ff;">${templateKey}</span></div>
    ${sections.map(section => `
      <div class="card" style="box-shadow: 0 2px 12px #cde6b6;">
        <div class="section-title">${section.name} ${section.type === 'static'
          ? '<span class="static-badge">Static Section</span>'
          : '<span class="dynamic-badge">Dynamic Section</span>'}</div>
        <div class="section-desc">${section.description || ""}</div>
        <div class="field-list" style="flex-direction:column;">
          ${section.fields.map(field => `
            <div class="field-pill">
              <div>
                <span class="field-label">${field.name}</span>
                <span class="field-type-badge">${field.type}</span>
                ${field.static ? "<span class='static-badge'>Static</span>" : ""}
                ${field.required ? "<span class='required-badge'>Required</span>" : ""}
                ${field.options && field.options.length ? "<span class='options-badge'>Options</span>" : ""}
              </div>
              ${field.help ? `<div class="description">${field.help}</div>` : ""}
              ${field.options && field.options.length ? `<div class="description" style="color:#f39c12;">${field.options.join(", ")}</div>` : ""}
            </div>
          `).join("")}
        </div>
      </div>
    `).join("")}
  `;
}

document.getElementById("edit-btn").onclick = function() {
  document.getElementById("step-preview").style.display = "none";
  document.getElementById("builder-area").style.display = "";
  updateTemplateLabelDisplay();
  editMode = true;
};

document.getElementById("save-template-btn").onclick = async function() {
  const templateRef = database.ref('global_templates/' + templateKey);
  const existing = await templateRef.get();
  if (existing.exists() && editMode) {
    showModal("Are you sure you want to overwrite the existing template?");
    document.getElementById("modal-confirm-btn").onclick = async function() {
      await actuallySaveTemplate(templateRef);
      hideModal();
    };
    document.getElementById("modal-cancel-btn").onclick = function() {
      hideModal();
    };
    return;
  }
  await actuallySaveTemplate(templateRef);
};

async function actuallySaveTemplate(templateRef) {
  const templateData = {
    key: templateKey,
    label: templateLabel,
    sections: sections,
    version: 1
  };
  try {
    await templateRef.set(templateData);
    document.getElementById("save-status").textContent = "Template saved! ðŸŽ‰";
    document.getElementById("save-template-btn").style.display = "none";
    document.getElementById("after-save-btns").style.display = "flex";
    editMode = false;
  } catch (err) {
    document.getElementById("save-status").textContent = "";
    alert("Error saving template: " + err.message);
  }
}

document.getElementById("create-another-btn").onclick = function() {
  templateKey = "";
  templateLabel = "";
  sections = [];
  addingFieldToSectionIdx = null;
  editingSectionIdx = null;
  document.getElementById("template-name").value = "";
  document.getElementById("step-preview").style.display = "none";
  document.getElementById("builder-area").style.display = "none";
  document.getElementById("step-name").style.display = "";
  document.getElementById("save-status").textContent = "";
  document.getElementById("after-save-btns").style.display = "none";
  document.getElementById("save-template-btn").style.display = "";
};

document.getElementById("admin-btn").onclick = function() {
  window.location.href = "/connect/admin.html";
};

function showModal(message) {
  document.getElementById("modal-message").textContent = message;
  document.getElementById("modal-bg").style.display = "flex";
}
function hideModal() {
  document.getElementById("modal-bg").style.display = "none";
}
</script>
</body>
</html>
