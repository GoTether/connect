<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Template Creator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZoL7FPJ8wBqz_sX81Fo5eKXpsOVrLUZ0",
      authDomain: "tether-71e0c.firebaseapp.com",
      databaseURL: "https://tether-71e0c-default-rtdb.firebaseio.com",
      projectId: "tether-71e0c",
      storageBucket: "tether-71e0c.appspot.com",
      messagingSenderId: "277809008742",
      appId: "1:277809008742:web:2586a2b821d8da8f969da7",
      measurementId: "G-X7ZQ6DJYEN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.saveToFirebase = async function(template) {
      try {
        await set(ref(db, 'global_templates/' + template.key), template);
        document.getElementById('status').textContent = '✅ Template saved to Firebase!';
      } catch (err) {
        document.getElementById('status').textContent = '❌ Error saving template: ' + err.message;
      }
    };
  </script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
  <main class="max-w-4xl mx-auto p-6 bg-white rounded-xl shadow-md mt-10">
    <h1 class="text-2xl font-bold mb-6">Template Creator</h1>
    <div class="mb-6">
      <span class="font-semibold">Tether Type:</span>
      <label class="inline-flex items-center ml-4">
        <input type="radio" name="log_scope" value="aura" checked class="mr-2">Aura
      </label>
      <label class="inline-flex items-center ml-6">
        <input type="radio" name="log_scope" value="terra" class="mr-2">Terra
      </label>
    </div>
    <div class="grid grid-cols-1 gap-4 mb-6">
      <div>
        <label class="block font-medium mb-1" for="template-label">Template Label</label>
        <input id="template-label" type="text" class="w-full border border-gray-300 p-2 rounded" required />
      </div>
    </div>
    <div id="sections-container" class="space-y-6 mb-6"></div>
    <div class="mb-6">
      <button id="add-section" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">+ Add Section</button>
    </div>
    <div class="mt-8">
      <button id="submit-template" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 font-bold">Create Template</button>
      <div id="status" class="text-red-600 mt-2"></div>
    </div>
  </main>

  <script>
    let sections = [];
    const existingTemplateLabels = ["car maintenance log", "furnace maintenance tracker", "guest room / vacation rental log"];

    function renderSections() {
      const container = document.getElementById('sections-container');
      container.innerHTML = '';
      sections.forEach((section, sidx) => {
        const sectionEl = document.createElement('div');
        sectionEl.className = 'border p-4 rounded bg-gray-50';
        sectionEl.innerHTML = `
          <div class="flex justify-between items-center mb-4">
            <h2 class="font-semibold text-lg">Section ${sidx + 1}</h2>
            <button class="text-red-500 hover:underline" onclick="removeSection(${sidx})">Delete Section</button>
          </div>
          <div class="grid grid-cols-1 gap-4 mb-4">
            <div>
              <label class="block font-medium mb-1">Section Name</label>
              <input type="text" class="w-full border border-gray-300 p-2 rounded" value="${section.name}" onchange="sections[${sidx}].name = this.value" />
            </div>
            <div>
              <label class="block font-medium mb-1">Description</label>
              <input type="text" class="w-full border border-gray-300 p-2 rounded" value="${section.description}" onchange="sections[${sidx}].description = this.value" />
            </div>
            <div>
              <label class="block font-medium mb-1">Section Type</label>
              <select class="w-full border border-gray-300 p-2 rounded" onchange="sections[${sidx}].type = this.value">
                <option value="static" ${section.type === 'static' ? 'selected' : ''}>Static</option>
                <option value="dynamic" ${section.type === 'dynamic' ? 'selected' : ''}>Dynamic</option>
              </select>
            </div>
          </div>
          <div class="space-y-3" id="fields-container-${sidx}">${renderFieldsHTML(sidx)}</div>
          <div class="mt-4">
            <button class="bg-gray-700 text-white px-3 py-1 rounded" onclick="addField(${sidx})">+ Add Field</button>
          </div>
        `;
        container.appendChild(sectionEl);
      });
    }

    function renderFieldsHTML(sidx) {
      return sections[sidx].fields.map((field, fidx) => `
        <div class="p-3 border rounded bg-white">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium">Field Name</label>
              <input type="text" class="w-full border border-gray-300 p-2 rounded" value="${field.name}" onchange="sections[${sidx}].fields[${fidx}].name = this.value" />
            </div>
            <div>
              <label class="block text-sm font-medium">Field Type</label>
              <select class="w-full border border-gray-300 p-2 rounded" onchange="updateFieldType(${sidx}, ${fidx}, this.value)">
                <option value="text" ${field.type === 'text' ? 'selected' : ''}>Text</option>
                <option value="number" ${field.type === 'number' ? 'selected' : ''}>Number</option>
                <option value="textarea" ${field.type === 'textarea' ? 'selected' : ''}>Textarea</option>
                <option value="dropdown" ${field.type === 'dropdown' ? 'selected' : ''}>Dropdown</option>
                <option value="radio" ${field.type === 'radio' ? 'selected' : ''}>Radio</option>
                <option value="checkbox" ${field.type === 'checkbox' ? 'selected' : ''}>Checkbox</option>
                <option value="stars" ${field.type === 'stars' ? 'selected' : ''}>Stars</option>
                <option value="photo" ${field.type === 'photo' ? 'selected' : ''}>Photo</option>
              </select>
            </div>
            <div class="col-span-2" style="display:${field.type === 'dropdown' ? 'block' : 'none'}">
              <label class="block text-sm font-medium">Dropdown Options (comma separated)</label>
              <input type="text" class="w-full border border-gray-300 p-2 rounded" value="${field.options ? field.options.join(', ') : ''}" onchange="sections[${sidx}].fields[${fidx}].options = this.value.split(',').map(o => o.trim())" />
            </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium">Help Text</label>
              <input type="text" class="w-full border border-gray-300 p-2 rounded" value="${field.help || ''}" onchange="sections[${sidx}].fields[${fidx}].help = this.value" />
            </div>
            <div>
              <label class="block text-sm font-medium">Required?</label>
              <select class="w-full border border-gray-300 p-2 rounded" onchange="sections[${sidx}].fields[${fidx}].required = (this.value === 'true')">
                <option value="true" ${field.required ? 'selected' : ''}>Yes</option>
                <option value="false" ${!field.required ? 'selected' : ''}>No</option>
              </select>
            </div>
          </div>
        </div>
      `).join('');
    }

    function updateFieldType(sidx, fidx, newType) {
      sections[sidx].fields[fidx].type = newType;
      renderSections();
    }

    function addSection() {
      sections.push({ name: '', description: '', type: 'static', undeletable: true, fields: [] });
      renderSections();
    }

    function removeSection(index) {
      sections.splice(index, 1);
      renderSections();
    }

    function addField(sidx) {
      const sectionType = sections[sidx].type;
      sections[sidx].fields.push({ name: '', type: 'text', required: false, static: sectionType === 'static', help: '' });
      renderSections();
    }

    document.getElementById('add-section').addEventListener('click', addSection);

    document.getElementById('submit-template').addEventListener('click', () => {
      const label = document.getElementById('template-label').value.trim();
      const logScope = document.querySelector('input[name="log_scope"]:checked').value;

      if (!label || sections.length === 0) {
        document.getElementById('status').textContent = 'Please fill in all required fields and add at least one section.';
        return;
      }

      if (existingTemplateLabels.includes(label.toLowerCase())) {
        document.getElementById('status').textContent = 'A template with this label already exists.';
        return;
      }

      const key = label.toLowerCase().replace(/\s+/g, '-');

      const template = {
        key,
        label,
        log_scope: logScope,
        version: 1,
        sections
      };

      saveToFirebase(template);
    });

    renderSections();
  </script>
</body>
</html>
