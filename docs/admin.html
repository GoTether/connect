<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tether Admin Dashboard</title>
  <script type="module">
    import { database } from './firebase-init.js';
    import { ref, get, child } from "firebase/database";

    async function loadStats() {
      const stats = {
        totalTethers: 0,
        terraTethers: 0,
        auraTethers: 0,
        terraEntries: 0,
        auraEntries: 0,
        topTethers: [],
      };

      // 1-3. Load all tethers
      const tethersSnap = await get(ref(database, 'tethers'));
      const tethers = tethersSnap.exists() ? tethersSnap.val() : {};
      stats.totalTethers = Object.keys(tethers).length;
      for (const [tid, t] of Object.entries(tethers)) {
        if (t.log_scope === "Aura") stats.auraTethers++;
        else stats.terraTethers++;
      }

      // 4. Terra entries count + 6. Top tethers (by terra log entry count)
      const sharedLogsSnap = await get(ref(database, 'shared_logs'));
      const sharedLogs = sharedLogsSnap.exists() ? sharedLogsSnap.val() : {};
      const tetherEntryCounts = {};
      for (const [tid, logData] of Object.entries(sharedLogs)) {
        const entries = logData.entries ? Object.values(logData.entries) : [];
        stats.terraEntries += entries.length;
        tetherEntryCounts[tid] = entries.length;
      }

      // 5. Aura entries count (across all users)
      const usersSnap = await get(ref(database, 'users'));
      const users = usersSnap.exists() ? usersSnap.val() : {};
      let auraEntryCounts = {}; // {tetherId: count}
      for (const [uid, userData] of Object.entries(users)) {
        if (!userData.logs) continue;
        for (const [tid, logData] of Object.entries(userData.logs)) {
          const entries = logData.entries ? Object.values(logData.entries) : [];
          stats.auraEntries += entries.length;
          auraEntryCounts[tid] = (auraEntryCounts[tid] || 0) + entries.length;
        }
      }

      // Combine both Terra and Aura entry counts for top tethers
      const allEntryCounts = {};
      Object.entries(tetherEntryCounts).forEach(([tid, count]) => {
        allEntryCounts[tid] = (allEntryCounts[tid] || 0) + count;
      });
      Object.entries(auraEntryCounts).forEach(([tid, count]) => {
        allEntryCounts[tid] = (allEntryCounts[tid] || 0) + count;
      });
      // Sort and get top 10
      stats.topTethers = Object.entries(allEntryCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      return stats;
    }

    function renderStats(stats) {
      const statBlock = document.getElementById('stats');
      statBlock.innerHTML = `
        <h2>System Stats</h2>
        <ul>
          <li><strong>Total Tethers:</strong> ${stats.totalTethers}</li>
          <li><strong>Terra Tethers:</strong> ${stats.terraTethers}</li>
          <li><strong>Aura Tethers:</strong> ${stats.auraTethers}</li>
          <li><strong>Total Terra Log Entries:</strong> ${stats.terraEntries}</li>
          <li><strong>Total Aura Log Entries:</strong> ${stats.auraEntries}</li>
        </ul>
        <h3>Top 10 Most Active Tethers (by entry count)</h3>
        <ol>
          ${stats.topTethers.map(([tid, count]) =>
            `<li><strong>${tid}</strong>: ${count} entries</li>`
          ).join('')}
        </ol>
        <p>
          <a href="templatecreator.html" target="_blank" style="font-weight:bold;">Open Template Creator</a>
        </p>
      `;
    }

    window.addEventListener('DOMContentLoaded', async () => {
      const statBlock = document.getElementById('stats');
      statBlock.innerHTML = "<em>Loading stats...</em>";
      try {
        const stats = await loadStats();
        renderStats(stats);
      } catch (e) {
        statBlock.innerHTML = `<span style="color:#b00;">Error loading stats: ${e.message}</span>`;
      }
    });
  </script>
  <style>
    body { font-family: sans-serif; margin: 2em; background: #f7f7f7; }
    #stats { background: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 2px 6px #ccc; }
    h2, h3 { margin-top: 0; }
    ul, ol { margin: 1em 0; }
    li { margin-bottom: 0.4em; }
    a { color: #0366d6; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div id="stats"></div>
</body>
</html>
