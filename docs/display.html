<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tether Log</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="./assets/firebase-init.js"></script>
  <script type="module">
    import { ref, get, set, push, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { onAuthStateChanged, signInAnonymously, getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { database } from './assets/firebase-init.js';

    const params = new URLSearchParams(window.location.search);
    const tetherId = params.get('id');
    const auth = getAuth();

    let uid = null;
    let template = null;
    let staticPath = null;
    let logPath = null;

    const statusText = document.getElementById('status-text');
    const staticContainer = document.getElementById('static-fields');
    const logForm = document.getElementById('log-form');
    const entriesContainer = document.getElementById('entries');

    if (!tetherId) {
      statusText.innerText = "No Tether ID found in URL.";
    }

    onAuthStateChanged(auth, async user => {
      if (!user) await signInAnonymously(auth);
      uid = auth.currentUser.uid;
      await loadTether();
    });

    async function loadTether() {
      const tetherSnap = await get(ref(database, `tethers/${tetherId}`));
      if (!tetherSnap.exists()) return statusText.innerText = "Tether not found.";
      const tether = tetherSnap.val();

      // Load template
      const templateSnap = await get(ref(database, `global_templates/${tether.template_id}`));
      if (!templateSnap.exists()) return statusText.innerText = "Template not found.";
      template = templateSnap.val();

      // Set static and log paths
      staticPath = `tethers/${tetherId}/static`;
      logPath = (template.log_scope === "terra")
        ? `shared_logs/${tetherId}/entries`
        : `users/${uid}/logs/${tether.template_id}/entries`;

      renderStaticSection();
      renderLogForm();
      renderEntries();
    }

    async function renderStaticSection() {
      const snap = await get(ref(database, staticPath));
      const values = snap.exists() ? snap.val() : {};

      staticContainer.innerHTML = `<h2 class="text-xl font-semibold mb-2">Info</h2>` +
        template.static_fields.map(field => {
          const val = values[field.name] || "â€”";
          return `<div class="mb-2">
            <div class="text-gray-400 text-sm">${field.name}</div>
            <div class="text-white font-medium">${val}</div>
          </div>`;
        }).join('');
    }

    function renderLogForm() {
      logForm.innerHTML = `<h2 class="text-xl font-semibold mb-4">Log Entry</h2>` +
        template.dynamic_fields.map(field => {
          const name = field.name;
          const label = `<label class="block mb-1 text-gray-300">${name}</label>`;
          const classes = "w-full px-3 py-2 rounded bg-slate-800 text-white border border-slate-600";
          if (field.type === "text" || field.type === "number")
            return `<div class="mb-4">${label}<input type="${field.type}" name="${name}" class="${classes}"></div>`;
          if (field.type === "textarea")
            return `<div class="mb-4">${label}<textarea name="${name}" rows="3" class="${classes}"></textarea></div>`;
          if (field.type === "dropdown")
            return `<div class="mb-4">${label}<select name="${name}" class="${classes}">` +
              field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('') + `</select></div>`;
          if (field.type === "radio")
            return `<div class="mb-4">${label}` +
              field.options.map(opt =>
                `<label class="inline-flex items-center mr-4 text-gray-200">
                  <input type="radio" name="${name}" value="${opt}" class="mr-1">${opt}
                </label>`
              ).join('') + `</div>`;
          if (field.type === "checkbox")
            return `<div class="mb-4"><label class="inline-flex items-center text-gray-200">
              <input type="checkbox" name="${name}" class="mr-2">${name}
            </label></div>`;
        }).join('') +
        `<button class="mt-2 bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700" id="submit-log">Submit</button>`;

      document.getElementById("submit-log").onclick = async () => {
        const entry = { _timestamp: new Date().toISOString() };
        for (const field of template.dynamic_fields) {
          const el = logForm.querySelector(`[name="${field.name}"]`);
          if (!el) continue;
          if (field.type === "checkbox") {
            entry[field.name] = el.checked;
          } else if (field.type === "radio") {
            const selected = logForm.querySelector(`[name="${field.name}"]:checked`);
            if (selected) entry[field.name] = selected.value;
          } else {
            entry[field.name] = el.value;
          }
        }

        // Add geolocation if allowed
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(async pos => {
            entry._geo = {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
              accuracy: pos.coords.accuracy
            };
            await push(ref(database, logPath), entry);
            logForm.reset();
            renderEntries();
          }, async () => {
            await push(ref(database, logPath), entry);
            logForm.reset();
            renderEntries();
          });
        } else {
          await push(ref(database, logPath), entry);
          logForm.reset();
          renderEntries();
        }
      };
    }

    async function renderEntries() {
      const snap = await get(ref(database, logPath));
      if (!snap.exists()) return entriesContainer.innerHTML = "<p class='text-gray-400'>No entries yet.</p>";

      const entries = Object.values(snap.val()).reverse();
      entriesContainer.innerHTML = `<h2 class="text-xl font-semibold mb-2 mt-6">Log History</h2>` +
        entries.map(entry => `
          <div class="bg-slate-800 p-4 rounded-lg mb-3 shadow">
            ${template.dynamic_fields.map(field => {
              const val = entry[field.name] ?? "â€”";
              return `<div class="text-sm"><span class="text-gray-400">${field.name}:</span> ${val}</div>`;
            }).join('')}
            <div class="text-xs text-gray-500 mt-2">ðŸ•’ ${new Date(entry._timestamp).toLocaleString()}</div>
          </div>
        `).join('');
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;600&display=swap');
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-800 via-slate-900 to-black text-white min-h-screen p-6">

  <div class="max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold text-center mb-4">Tether Log</h1>
    <p id="status-text" class="text-center text-gray-400 mb-6">Loading...</p>

    <div id="static-fields" class="mb-8"></div>
    <form id="log-form" class="mb-8"></form>
    <div id="entries"></div>
  </div>

</body>
</html>
