<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Display Tether</title>
  <script type="module">
    import { database } from './firebase-init.js';
    import { ref, get, set, update, push, remove } from "firebase/database";

    function getQueryParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    // Enhanced searchable dropdown for templates
    function renderTemplateDropdown(templates, onSelect) {
      const container = document.createElement('div');
      container.style.maxWidth = '500px';
      container.style.margin = '2em auto';

      const searchInput = document.createElement('input');
      searchInput.type = 'text';
      searchInput.placeholder = 'Search templates...';
      searchInput.style.width = '100%';
      searchInput.style.marginBottom = '1em';

      const list = document.createElement('div');
      list.id = 'template-dropdown-list';

      function renderList(filterText = '') {
        list.innerHTML = '';
        templates
          .filter(t => 
            t.label.toLowerCase().includes(filterText) ||
            t.key.toLowerCase().includes(filterText) ||
            t.fields.join(' ').toLowerCase().includes(filterText)
          )
          .forEach(template => {
            const item = document.createElement('div');
            item.className = 'template-list-item';
            item.style.padding = '0.6em 1em';
            item.style.marginBottom = '0.6em';
            item.style.border = '1px solid #ccc';
            item.style.borderRadius = '6px';
            item.style.cursor = 'pointer';
            item.style.background = '#fafaff';

            item.innerHTML = `
              <div style="font-weight:bold; font-size:1.1em;">${template.label} <span style="color:#777; font-size:0.9em;">(${template.key})</span></div>
              <div style="color:#444; margin-top:0.3em;">
                <strong>Fields:</strong> ${template.fields.length ? template.fields.join(', ') : '<span style="color:#999;">None</span>'}
              </div>
              <div style="font-size:0.9em; color:#999;">Version: ${template.version ?? 'N/A'}</div>
            `;

            item.addEventListener('click', () => onSelect(template));

            item.addEventListener('mouseover', () => item.style.background = '#e8f5ff');
            item.addEventListener('mouseout', () => item.style.background = '#fafaff');

            list.appendChild(item);
          });
      }

      searchInput.addEventListener('input', () => {
        renderList(searchInput.value.trim().toLowerCase());
      });

      container.appendChild(searchInput);
      container.appendChild(list);
      renderList('');
      return container;
    }

    // Fetch all global templates with key, label, fields, version
    async function fetchAllTemplates() {
      const snap = await get(ref(database, 'global_templates'));
      if (!snap.exists()) return [];
      const raw = snap.val();
      return Object.entries(raw).map(([key, val]) => ({
        key,
        label: val.label || key,
        fields: Array.isArray(val.fields) ? val.fields : [],
        version: val.version ?? null
      }));
    }

    async function main() {
      const id = getQueryParam('id');
      if (!id) {
        document.body.innerHTML = "<h2>No tether id provided.</h2>";
        return;
      }

      const tetherRef = ref(database, `tethers/${id}`);
      const snap = await get(tetherRef);

      if (!snap.exists()) {
        // Unassigned Tether: fetch all templates and display enhanced selector
        document.body.innerHTML = "<h2>Select a Template for this Tether</h2><div id='template-selector'></div>";
        const templates = await fetchAllTemplates();
        if (!templates.length) {
          document.getElementById('template-selector').innerHTML = "<em>No templates found.</em>";
          return;
        }

        const selector = renderTemplateDropdown(templates, async selected => {
          // Set up Tether in Firebase
          await set(tetherRef, {
            log_scope: "Terra",
            template: selected.key,
            template_version: selected.version ?? null,
            static_fields: {}
          });
          location.reload();
        });

        document.getElementById('template-selector').appendChild(selector);
        return;
      }

      // ... rest of display.html logic (not shown, as this enhancement is for template selection only)
    }

    window.addEventListener('DOMContentLoaded', main);
  </script>
  <style>
    body { font-family: sans-serif; background: #f7f7fa; margin: 2em; }
    h2 { margin-top: 1em; }
    .template-list-item:hover { box-shadow: 0 0 8px #b3d9fa; }
    input[type="text"] { padding: 0.4em; border-radius: 5px; border: 1px solid #ccc; }
  </style>
</head>
<body>
</body>
</html>